# FastAPI проект с JWT авторизацией, ролевой моделью и подтверждением регистрации по email

Современное и безопасное backend-приложение на основе FastAPI, предназначенное для управления аутентификацией пользователей, ролевого доступа и отправки email. Проект предоставляет масштабируемую основу для управления учетными записями с поддержкой JWT-аутентификации, валидации паролей, подтверждения email и ограничения частоты запросов.

## Основные особенности и преимущества

### 1. **Безопасная система аутентификации**
- **JWT-аутентификация**. Использует access и refresh-токены с асимметричным шифрованием (RSA) для защиты пользовательских сессий.
- **Управление refresh-токенами**. Хранение и отслеживание токенов в базе данных с автоматическим отзывом при выходе или обновлении.
- **Безопасность паролей**. Применение bcrypt для хеширования паролей и настраиваемая валидация (уровни: light, medium, strong) для предотвращения создания учетных записей со слабыми паролями.
- **Хранение токенов в cookies**. Токены сохраняются в HTTP-only, secure cookies с SameSite для защиты от XSS и CSRF-атак.

### 2. **Гибкое управление пользователями**
- **Ролевой доступ (RBAC)**. Поддержка ролей (USER, ADMIN) с возможностью расширения.
- **Детальная информация о пользователе**. Хранение email, имени, номера телефона, даты рождения и данных об активности.
- **Функции безопасности учетной записи**.
  - Подтверждение email с использованием токенов.
  - Сброс пароля через защищенные токены.
  - Блокировка учетной записи с фиксацией времени.

### 3. **Интеграция с email**
- **Асинхронная отправка писем**. Использование `aiosmtplib` для надежной доставки с механизмом повторных попыток при сетевых сбоях.
- **Настраиваемые шаблоны**. Рендеринг HTML-шаблонов с помощью Jinja2 для писем подтверждения и сброса пароля.
- **Гибкие SMTP-настройки**. Поддержка любого SMTP-сервера через переменные окружения.

### 4. **Надежная интеграция с базой данных**
- **SQLAlchemy ORM**. Асинхронный, типобезопасный интерфейс для работы с базой данных.
- **Поддержка разных СУБД**. Настройка для PostgreSQL или SQLite через переменные окружения.
- **Шаблон репозитория**. Универсальные CRUD-операции для моделей, минимизирующие дублирование кода.

### 5. **Ограничение запросов и безопасность**
- **Rate Limiting**. Использование `slowapi` для ограничения частоты запросов на критических эндпоинтах (регистрация, вход).
- **Обработка исключений**. Централизованная обработка ошибок с логированием серверных ошибок и понятными сообщениями для клиента.
- **Валидация данных**. Использование Pydantic для строгой проверки входных данных.

### 6. **Удобство для разработчиков**
- **Модульная архитектура**. Код организован по модулям (`auth` и `email`) для удобства поддержки.
- **Логирование**. Ошибки и ключевые события записываются в файл и консоль.
- **Конфигурация через .env**. Управление настройками с помощью Pydantic `BaseSettings`.

## Структура проекта

```plaintext
├── alembic/                    # Миграции базы данных
├── src/
│   ├── auth/
│   │   ├── schemas/            # Pydantic-модели для запросов и ответов
│   │   ├── utils/              # Утилиты для JWT, паролей, cookies
│   │   ├── constants.py        # Определение ролей
│   │   ├── dependencies.py     # Зависимости FastAPI для аутентификации
│   │   ├── router.py           # Эндпоинты аутентификации
│   │   ├── services.py         # Бизнес-логика для пользователей и токенов
│   ├── email/
│   │   ├── schemas/            # Pydantic-модели для email
│   │   ├── utils/              # Утилиты для отправки писем и рендеринга шаблонов
│   │   ├── router.py           # Эндпоинты для работы с email
│   ├── limits/
│   │   ├── limiter.py          # Настройка ограничения запросов
│   ├── logs/
│   │   ├── logger.py           # Конфигурация логирования
│   ├── config.py               # Настройки приложения
│   ├── database.py             # Настройка SQLAlchemy
│   ├── exceptions.py           # Пользовательские исключения
│   ├── main.py                 # Точка входа FastAPI
│   ├── models.py               # Модели SQLAlchemy
│   ├── services.py             # Универсальный шаблон репозитория
├── .env-example                # Пример .env файла
├── alembic.ini                 # Конфигурация Alembic
├── private.pem-example         # Пример приватного ключа
├── public.pem-example          # Пример публичного ключа
├── requirements.txt            # Зависимости проекта
```

## Установка

1. **Клонирование репозитория**.
   ```bash
   git clone https://github.com/Petyall/fastapi_jwt
   cd fastapi_jwt
   ```

2. **Создание виртуального окружения**.
   ```bash
   python -m venv venv
   source venv/bin/activate  # Для Windows: venv\Scripts\activate
   ```

3. **Установка зависимостей**.
   ```bash
   pip install -r requirements.txt
   ```

4. **Настройка переменных окружения**.
   Создайте файл `.env` в корне проекта на основе `.env-example`. Пример:
   ```env
   DB_TYPE=postgresql
   DB_HOST=localhost
   DB_PORT=5432
   DB_USER=your_user
   DB_PASS=your_password
   DB_NAME=your_database
   JWT_PRIVATE_KEY_PATH=private.pem
   JWT_PUBLIC_KEY_PATH=public.pem
   SMTP_HOST=smtp.example.com
   SMTP_PORT=587
   SMTP_USERNAME=your_smtp_user
   SMTP_PASSWORD=your_smtp_password
   EMAIL_FROM=no-reply@example.com
   FRONTEND_URL=http://localhost:3000
   ```

5. **Применение миграций базы данных**:
   ```bash
   alembic upgrade head
   ```

6. **Запуск приложения**.
   ```bash
   uvicorn src.main:app --reload
   ```

## Эндпоинты API

### Аутентификация
- **POST /auth/register**. Регистрация нового пользователя (с опциональным подтверждением email).
- **POST /auth/login**. Аутентификация пользователя и установка токенов в cookies.
- **POST /auth/logout**. Выход из системы и отзыв refresh-токена.
- **POST /auth/refresh**. Обновление access- и refresh-токенов.
- **POST /auth/forgot-password**. Инициирование сброса пароля.
- **POST /auth/reset-password**. Сброс пароля по токену.
- **GET /auth/check**. Проверка прав администратора.

### Email
- **POST /email/confirm**. Подтверждение email по токену.
- **POST /email/resend**. Повторная отправка письма подтверждения.

## Требования

- Python 3.10+
- PostgreSQL или SQLite
- SMTP-сервер для отправки писем
- Зависимости из `requirements.txt`

## Миграции базы данных

Проект использует Alembic для управления схемой базы данных. Для создания новой миграции:
```bash
alembic revision --autogenerate -m "Описание миграции"
```
Для применения миграций:
```bash
alembic upgrade head
```